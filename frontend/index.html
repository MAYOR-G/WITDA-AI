<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WITDA-AI (Pro Refactor V2 — wired)</title>

  <script>const API_BASE = (window.API_BASE || "http://localhost:8000");</script>

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter','system-ui','sans-serif'] },
          colors: {
            background:'#121212',
            sidebar:'#1E1E1E',
            composer:'#2A2A2A',
            'border-subtle':'#3a3a3a',
            accent:{ DEFAULT:'#6366F1', hover:'#4F46E5' },
            text:{ primary:'#E5E7EB', secondary:'#9CA3AF', placeholder:'#71717A' }
          },
          boxShadow:{
            composer:'0 0 15px 5px rgba(0,0,0,.1), 0 0 5px 1px rgba(0,0,0,.05)',
            'button-glow':'0 0 8px 2px rgba(99,102,241,.5)'
          }
        }
      }
    };
  </script>

  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>

  <script src="https://cdn.jsdelivr.net/npm/marked@12/marked.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11/styles/vs2015.min.css">
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11/lib/common.min.js"></script>

  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone@7/babel.min.js"></script>

  <style>
    :root{
      --bg:#121212; --fg:#E5E7EB; --muted:#9CA3AF; --placeholder:#71717A;
      --surface:#2A2A2A; --panel:#1E1E1E; --accent:#6366F1; --accentHover:#4F46E5;
      --hash:#2e2e2e; --hashBorder:#3a3a3a;
    }
    .light{
      --bg:#f7f7f9; --fg:#0f172a; --muted:#475569; --placeholder:#6b7280;
      --surface:#ffffff; --panel:#ffffff; --accent:#6366F1; --accentHover:#4F46E5;
      --hash:#ececff; --hashBorder:#c7c9ff;
    }
    html, body { height:100%; }
    body{ margin:0; background:var(--bg); color:var(--fg); font-family:Inter,system-ui,sans-serif; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; overflow:hidden;}
    ::-webkit-scrollbar{ width:6px; height:6px }
    ::-webkit-scrollbar-track{ background:var(--surface) }
    ::-webkit-scrollbar-thumb{ background:#3a3a3a; border-radius:9999px }
    .light ::-webkit-scrollbar-thumb{ background:#cbd5e1 }
    .markdown-body{ line-height:1.65; font-size:1rem; color:var(--fg) }
    .markdown-body h1,.markdown-body h2,.markdown-body h3{ color:var(--fg); margin:.25rem 0 .75rem }
    .markdown-body p{ margin:0 0 1rem }
    .markdown-body a{ color:var(--accent); text-decoration:underline }
    .markdown-body code{ color:var(--accent); background:var(--panel); padding:.125rem .25rem; border-radius:.25rem; font-family:ui-monospace,Menlo,Monaco,Roboto Mono,Courier New,monospace; font-size:.9em }
    .markdown-body pre{ background:var(--panel); border-radius:.5rem; overflow:auto }
    .markdown-body pre code{ background:transparent; display:block; padding:1rem }
    .message-row { width:100%; display:flex; padding-left:10rem; padding-right:10rem; margin-bottom:.75rem; }
    .msg-user{ background:var(--hash); border:1px solid var(--hashBorder); border-radius:16px; padding:14px 16px; box-shadow:0 0 20px rgba(0,0,0,.12); }
    .light .msg-user{ background:var(--accent); color:#fff; border-color:transparent; box-shadow:0 10px 20px rgba(99,102,241,.18); }
    .msg-assistant{ background:transparent; padding:0; border:none; }
    .stream{ width:100%; display:flex; flex-direction:column; align-items:center; }
    @keyframes spin{ to{ transform:rotate(360deg)} }
  </style>
</head>
<body>
  <div id="root"></div>

  <details class="fixed right-4 bottom-4 opacity-30 hover:opacity-100 transition-opacity z-40">
    <summary class="cursor-pointer text-xs">README & Run</summary>
    <div class="mt-2 p-4 rounded-lg w-96 text-xs" style="background:var(--panel); border:1px solid var(--hashBorder); color:var(--fg);">
      <h3 class="font-bold text-base mb-2">WITDA-AI Front-End (wired to FastAPI)</h3>
      <ol class="list-decimal list-inside space-y-1">
        <li>Start API: <code>uvicorn app:app --reload --port 8000</code></li>
        <li>Open this file in Chrome/Edge/Firefox.</li>
        <li>Use buttons: <b>Deep Research</b>, <b>Brief Explanation</b>, <b>Learn</b>.</li>
      </ol>
    </div>
  </details>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef } = React;

    const uuid = () => (crypto.randomUUID ? crypto.randomUUID()
      : 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c=>{
          const r = Math.random()*16|0, v = c==='x'?r:(r&0x3|0x8); return v.toString(16);
        })
    );

    const useLocal = (key, initial) => {
      const [val, setVal] = useState(() => {
        try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : initial; }
        catch { return initial; }
      });
      useEffect(()=>{ try { localStorage.setItem(key, JSON.stringify(val)); } catch{} }, [key,val]);
      return [val, setVal];
    };

    const Markdown = ({ text }) => {
      const html = useMemo(() => {
        marked.setOptions({
          highlight: (code, lang) => {
            try { return hljs.highlight(code, { language: lang || 'plaintext' }).value; }
            catch { return hljs.highlightAuto(code).value; }
          },
          breaks: true
        });
        return marked.parse(text || "");
      }, [text]);
      return <div className='markdown-body' dangerouslySetInnerHTML={{ __html: html }} />;
    };

    const Icon = {
      Menu:(p={})=>(<svg {...p} viewBox='0 0 24 24' fill='none' stroke='currentColor' strokeWidth={2}><path d='M4 6h16M4 12h16M4 18h16' strokeLinecap='round'/></svg>),
      Plus:(p={})=>(<svg {...p} viewBox='0 0 24 24' fill='none' stroke='currentColor' strokeWidth={2}><path d='M12 5v14M5 12h14' strokeLinecap='round' /></svg>),
      Send:(p={})=>(<svg {...p} viewBox='0 0 24 24' fill='none' stroke='currentColor' strokeWidth={2}><path d='M22 2L11 13' strokeLinecap='round' /><path d='M22 2l-7 20-4-9-9-4 20-7' strokeLinecap='round' strokeLinejoin='round' /></svg>),
      Share:(p={})=>(<svg {...p} viewBox='0 0 24 24' fill='none' stroke='currentColor' strokeWidth={2}><circle cx={18} cy={5} r={3} /><circle cx={6} cy={12} r={3} /><circle cx={18} cy={19} r={3} /><path d='M8.6 13.5l6.8 3.9M15.4 6.6L8.6 10.5' /></svg>),
      Loader:(p={})=>(<div {...p} style={{width:p.size||20,height:p.size||20,border:'2px solid var(--muted)',borderTopColor:'transparent',borderRadius:'50%',animation:'spin 1s linear infinite'}} />),
      Settings:(p={})=>(<svg {...p} viewBox='0 0 24 24' fill='none' stroke='currentColor' strokeWidth={2}><path d='M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7' /><path d='M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09c-.35 0-.7.08-1.02.22-.61.25-1 .85-1 1.51z' /></svg>)
    };

    const Header = ({ title, onToggleSidebar }) => (
      <div className='flex-shrink-0 flex items-center justify-between w-full h-16 px-4 md:px-6 border-b' style={{borderColor:'var(--hashBorder)'}}>
        <div className='flex items-center gap-2'>
          <button onClick={onToggleSidebar} className='text-[color:var(--muted)] hover:text-[color:var(--fg)]' aria-label='Toggle sidebar'>
            <Icon.Menu width={22} height={22} />
          </button>
          <h1 className='text-lg font-semibold truncate text-[color:var(--fg)]'>{title}</h1>
        </div>
        <button className='text-[color:var(--muted)] hover:text-[color:var(--fg)]' aria-label='Share or export chat'>
          <Icon.Share width={18} height={18} />
        </button>
      </div>
    );

    const ChatListItem = ({ title, isActive, onClick }) => (
      <button onClick={onClick}
        className={`w-full text-left px-3 py-2.5 rounded-lg text-sm truncate transition-colors ${
          isActive ? 'bg-[color:var(--surface)] text-[color:var(--fg)] font-medium'
                   : 'text-[color:var(--muted)] hover:bg-[color:var(--surface)] hover:text-[color:var(--fg)]'
        }`}
      >{title}</button>
    );

    const SettingsModal = ({ open, onClose, theme, setTheme }) => {
      if (!open) return null;
      return (
        <div className='fixed inset-0 z-50 flex items-center justify-center'>
          <div className='absolute inset-0 bg-black/50' onClick={onClose} />
          <div className='relative z-10 w-full max-w-md rounded-xl p-5' style={{ background:'var(--panel)', border:'1px solid var(--hashBorder)'}}>
            <h3 className='text-lg font-semibold mb-3 text-[color:var(--fg)]'>Settings</h3>
            <div className='flex items-center justify-between py-3'>
              <span className='text-sm text-[color:var(--muted)]'>Theme</span>
              <select value={theme} onChange={(e)=>setTheme(e.target.value)}
                className='bg-[color:var(--surface)] text-[color:var(--fg)] border rounded-md px-3 py-1.5'
                style={{borderColor:'var(--hashBorder)'}}
              >
                <option value='dark'>Dark</option>
                <option value='light'>Light</option>
              </select>
            </div>
            <div className='flex justify-end mt-4'>
              <button onClick={onClose} className='px-4 py-2 rounded-md bg-[color:var(--accent)] text-white hover:bg-[color:var(--accentHover)]'>
                Close
              </button>
            </div>
          </div>
        </div>
      );
    };

    const Sidebar = ({ isOpen, onClose, chats, currentChatId, onSelectChat, onCreateNewChat, isMobile, onOpenSettings }) => {
      if (!isOpen) return null;
      const list = chats.length ? chats.map(c =>
        <ChatListItem key={c.id} title={c.title} isActive={c.id===currentChatId} onClick={()=>onSelectChat(c.id)} />
      ) : <p className='text-sm text-[color:var(--muted)] px-2 py-4 text-center'>No chats yet.</p>;

      return (
        <div className='h-screen w-72 flex-shrink-0 border-r flex flex-col' style={{ background:'var(--panel)', borderColor:'var(--hashBorder)'}}>
          <div className='flex items-center justify-between p-3 shrink-0'>
            <div className='flex items-center gap-2'>
              <span className='p-1.5 rounded-lg' style={{background:'var(--accent)'}}>
                <svg width={24} height={24} viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'>
                  <path d='M12 2L2 7V17L12 22L22 17V7L12 2Z' fill='white' fillOpacity='.1' />
                  <path d='M2 7L12 12L22 7M12 12V22' stroke='white' strokeWidth='2' strokeLinecap='round' strokeLinejoin='round' />
                  <path d='M17 4.5L7 9.5' stroke='white' strokeWidth='2' strokeLinecap='round' strokeLinejoin='round' />
                </svg>
              </span>
              <span className='font-bold text-lg' style={{color:'var(--fg)'}}>WITDA-AI</span>
            </div>
            {isMobile && <button onClick={onClose} className='text-[color:var(--muted)] hover:text-[color:var(--fg)]'>✕</button>}
          </div>

          <div className='px-3 pb-3 shrink-0'>
            <button onClick={onCreateNewChat} className='flex w-full items-center justify-between rounded-lg px-4 py-3 text-sm font-medium transition-colors' style={{ background:'var(--surface)', color:'var(--fg)' }}>
              <span>New Chat</span>
              <Icon.Plus width={18} height={18} />
            </button>
          </div>

          <div className='flex-1 overflow-y-auto pt-2 space-y-1 pr-1'>
            <span className='text-xs font-medium px-4' style={{ color:'var(--muted)' }}>Today</span>
            <div className='px-3 space-y-1'>{list}</div>
          </div>

          <div className='p-3 border-t shrink-0' style={{ borderColor:'var(--hashBorder)'}}>
            <button onClick={onOpenSettings} className='w-full flex items-center justify-between rounded-lg px-3 py-2 hover:opacity-90' style={{ background:'var(--surface)', color:'var(--fg)'}}>
              <div className='flex items-center gap-3'>
                <span><Icon.Settings width={18} height={18} /></span>
                <span>Settings</span>
              </div>
              <span className='text-[color:var(--muted)]'>›</span>
            </button>
          </div>
        </div>
      );
    };

    const Message = ({ message }) => {
      const isUser = message.role === 'user';
      return (
        <div className={`message-row ${isUser ? 'justify-end' : 'justify-start'}`}>
          <div className={`bubble w-full ${isUser ? 'msg-user max-w-3xl' : 'msg-assistant max-w-5xl'}`}>
            {isUser && message.attachments?.length ? (
              <div className='flex flex-wrap gap-2 mb-2 text-sm' style={{ color:'var(--fg)'}}>
                {message.attachments.map((name,i)=>
                  <span key={i} className='px-2 py-1 rounded-full' style={{ background:'var(--panel)', border:'1px solid var(--hashBorder)' }}>
                    {name}
                  </span>
                )}
              </div>
            ) : null}
            <div className='markdown-body'>
              <Markdown text={message.content} />
            </div>
          </div>
        </div>
      );
    };

    const MessageList = ({ messages }) => {
      const endRef = useRef(null);
      useEffect(()=>{ endRef.current?.scrollIntoView({ behavior:'smooth' }); },[messages]);
      return (
        <div className='stream py-6'>
          {messages.map(m => <Message key={m.id} message={m} />)}
          <div ref={endRef} />
        </div>
      );
    };

    const Welcome = () => (
      <div className='flex flex-col justify-center items-center text-center py-24'>
        <div className='p-4 rounded-2xl mb-5' style={{ background:'var(--accent)'}}>
          <svg width={48} height={48} viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'>
            <path d='M12 2L2 7V17L12 22L22 17V7L12 2Z' fill='white' fillOpacity='.1' />
            <path d='M2 7L12 12L22 7M12 12V22' stroke='white' strokeWidth='2' strokeLinecap='round' strokeLinejoin='round' />
            <path d='M17 4.5L7 9.5' stroke='white' strokeWidth='2' strokeLinecap='round' strokeLinejoin='round' />
          </svg>
        </div>
        <h2 className='text-3xl md:text-4xl font-bold' style={{ color:'var(--fg)'}}>How can I help you?</h2>
      </div>
    );

    const MODES = [
      { id:'deep_research', label:'Deep Research' },
      { id:'brief_explanation', label:'Brief Explanation' },
      { id:'learn', label:'Learn' }
    ];

    const Composer = ({ onSend, isSending, onInputChange }) => {
      const [input,setInput] = useState('');
      const [activeMode,setActiveMode] = useState('deep_research');
      const [files,setFiles] = useState([]);
      const fileInputRef = useRef(null);
      const textareaRef = useRef(null);
      const [linksText,setLinksText] = useState(''); // optional URLs, comma/space separated

      useEffect(()=>{
        if (textareaRef.current){
          textareaRef.current.style.height='auto';
          textareaRef.current.style.height=`${textareaRef.current.scrollHeight}px`;
        }
      },[input]);

      const handleFileClick = ()=> fileInputRef.current?.click();
      const handleFileChange = async (e)=>{
        const newFiles = Array.from(e.target.files||[]);
        if (!newFiles.length) return;
        const fd = new FormData();
        newFiles.forEach(f => fd.append('files', f));
        try{
          const res = await fetch(`${API_BASE}/upload`, { method:'POST', body: fd });
          const json = await res.json();
          // Keep chip UI
          setFiles(prev => [...prev, ...newFiles].slice(0, 3));
        }catch(err){ console.error(err); }
        e.target.value = null;
      };
      const removeFile = (idx)=> setFiles(prev=>prev.filter((_,i)=>i!==idx));

      const submit = ()=>{
        const trimmed = input.trim();
        if (!trimmed && files.length===0) return;
        const links = linksText.split(/[\s,]+/g).map(s=>s.trim()).filter(Boolean);
        onSend({ message: trimmed, mode: activeMode, links });
        setInput(''); setFiles([]); setLinksText('');
        onInputChange && onInputChange(false);
      };
      const onKeyDown = (e)=>{ if (e.key==='Enter' && !e.shiftKey){ e.preventDefault(); submit(); } };
      const onTextChange = (e)=>{ setInput(e.target.value); onInputChange && onInputChange(e.target.value.trim().length > 0); };

      const fileChip = (file,i)=> (
        <div key={i} className='flex items-center gap-1.5 px-2.5 py-1 rounded-full text-sm' style={{ background:'var(--panel)', color:'var(--fg)', border:'1px solid var(--hashBorder)' }}>
          <span className='truncate max-w-xs'>{file.name}</span>
          <button onClick={()=>removeFile(i)} className='text-[color:var(--muted)] hover:text-[color:var(--fg)] rounded-full p-0.5' aria-label={`Remove ${file.name}`}>✕</button>
        </div>
      );

      return (
        <div className='w-full flex justify-center px-4 pb-4 sticky bottom-0' style={{ background:'linear-gradient(180deg, transparent, var(--bg) 40%)'}}>
          <div className='bubble msg-user w-full max-w-3xl'>
            <div>
              <div className='flex items-center gap-2 mb-3 px-1'>
                {MODES.map(m=>(
                  <button key={m.id} onClick={()=>setActiveMode(m.id)}
                    className={`px-3 py-1.5 rounded-full text-xs font-medium transition-all ${activeMode===m.id?'text-white shadow-button-glow':'text-[color:var(--muted)]'}`}
                    style={{ background: activeMode===m.id ? 'var(--accent)':'var(--panel)' }}
                  >{m.label}</button>
                ))}
              </div>

              {files.length > 0 && (<div className='flex flex-wrap gap-2 mb-2 px-1'>{files.map(fileChip)}</div>)}

              <div className='flex items-start gap-2.5 mb-2'>
                <input type='file' ref={fileInputRef} onChange={handleFileChange} multiple className='hidden' accept='image/*,application/pdf,.csv,.txt,.md,.markdown,.json' />
                <button onClick={handleFileClick} className='flex-shrink-0 w-9 h-9 flex items-center justify-center rounded-lg hover:opacity-90' aria-label='Add files'
                  style={{ color:'var(--fg)', background:'transparent', border:'1px solid var(--hashBorder)'}}>
                  <Icon.Plus width={20} height={20} />
                </button>
                <textarea ref={textareaRef} value={input} onChange={onTextChange} onKeyDown={onKeyDown}
                  placeholder='Message WITDA-AI'
                  className='flex-1 bg-transparent resize-none border-none outline-none ring-0 focus:ring-0 py-2.5 max-h-40 overflow-y-auto'
                  style={{ color:'var(--fg)' }} rows={1}
                />
                <button onClick={submit} disabled={isSending || (!input.trim() && !files.length)}
                  className='flex-shrink-0 w-9 h-9 flex items-center justify-center rounded-lg text-white transition-all disabled:opacity-50 disabled:cursor-not-allowed hover:opacity-90'
                  aria-label='Send message' style={{ background:'var(--accent)'}}>
                  {isSending ? <Icon.Loader size={20} /> : <Icon.Send width={18} height={18} />}
                </button>
              </div>

              <input value={linksText} onChange={e=>setLinksText(e.target.value)} placeholder='Optional: paste URLs to include (comma or space separated)'
                className='w-full text-xs px-3 py-2 rounded-lg bg-transparent border'
                style={{borderColor:'var(--hashBorder)', color:'var(--fg)'}} />
            </div>
          </div>
        </div>
      );
    };

    const ChatArea = ({ chat, onSend, isSending, onToggleSidebar }) => {
      const [composerHasInput, setComposerHasInput] = useState(false);
      const isNew = !chat;
      return (
        <div className='flex-1 h-screen flex flex-col'>
          <Header title={ chat?.title || 'New Chat'} onToggleSidebar={onToggleSidebar} />
          <div className='flex-1 overflow-y-auto'>
            {isNew ? (composerHasInput ? null : <Welcome />) : <MessageList messages={chat.messages} />}
          </div>
          <Composer onSend={onSend} isSending={isSending} onInputChange={setComposerHasInput} />
        </div>
      );
    };

    const App = () => {
      const [theme,setTheme] = useLocal('witda-theme','dark');
      useEffect(()=>{ if (theme==='light') document.body.classList.add('light'); else document.body.classList.remove('light'); },[theme]);

      const [isSidebarOpen,setIsSidebarOpen] = useState(window.innerWidth >= 1024);
      const [chats,setChats] = useLocal('witda-ai-chats', []);
      const [currentChatId,setCurrentChatId] = useState(null);
      const [isSending,setIsSending] = useState(false);
      const [isMobile,setIsMobile] = useState(window.innerWidth < 768);
      const [settingsOpen,setSettingsOpen] = useState(false);

      useEffect(()=>{
        const onResize = ()=> {
          const mobile = window.innerWidth < 768;
          setIsMobile(mobile);
          if (mobile) setIsSidebarOpen(false);
        };
        window.addEventListener('resize', onResize);
        return ()=> window.removeEventListener('resize', onResize);
      },[]);

      const currentChat = useMemo(()=> chats.find(c=>c.id===currentChatId) || null, [chats,currentChatId]);

      const toggleSidebar = ()=> setIsSidebarOpen(o=>!o);
      const createNewChat = ()=>{ setCurrentChatId(null); if (isMobile) setIsSidebarOpen(false); };
      const selectChat = (id)=>{ setCurrentChatId(id); if (isMobile) setIsSidebarOpen(false); };

      async function callChatAPI(payload){
        const res = await fetch(`${API_BASE}/chat`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error('API error');
        return await res.json();
      }

      const onSend = async ({ message, mode, links })=>{
        setIsSending(true);
        const userMsg = { id: uuid(), role:'user', content: message, attachments: [] };

        let updatedChatId = currentChatId;
        let updatedChats;
        if (!currentChat){
          const newId = uuid();
          updatedChatId = newId; setCurrentChatId(newId);
          const title = message?.length>30 ? message.slice(0,27)+'…' : (message || 'New Chat');
          const newChat = { id:newId, title, messages:[userMsg], lastUpdated: new Date().toISOString() };
          updatedChats = [newChat, ...chats];
        } else {
          updatedChats = chats.map(c => c.id===currentChatId ? { ...c, messages:[...c.messages, userMsg], lastUpdated:new Date().toISOString() } : c);
        }
        setChats(updatedChats);

        try{
          const api = await callChatAPI({ message, mode, chat_id: updatedChatId, links });
          const assistantMsg = { id: uuid(), role:'assistant', content: api.content };
          setChats(prev => prev.map(c => c.id===api.chat_id ? { ...c, id: api.chat_id, messages:[...c.messages, assistantMsg] } : c));
        }catch(err){
          console.error(err);
          const assistantMsg = { id: uuid(), role:'assistant', content: "**Error:** API is unavailable. Check server logs." };
          setChats(prev => prev.map(c => c.id===updatedChatId ? { ...c, messages:[...c.messages, assistantMsg] } : c));
        }
        setIsSending(false);
      };

      const sorted = useMemo(()=> [...chats].sort((a,b)=> new Date(b.lastUpdated) - new Date(a.lastUpdated)), [chats]);

      return (
        <div className='flex h-screen w-screen'>
          <div className='h-screen overflow-hidden'>
            <Sidebar
              isOpen={isSidebarOpen} onClose={()=>setIsSidebarOpen(false)}
              chats={sorted} currentChatId={currentChatId} onSelectChat={selectChat} onCreateNewChat={createNewChat} isMobile={isMobile}
              onOpenSettings={()=>setSettingsOpen(true)}
            />
          </div>
          <div className='flex-1 min-w-0'>
            <ChatArea chat={currentChat} onSend={onSend} isSending={isSending} onToggleSidebar={toggleSidebar} />
          </div>
          <SettingsModal open={settingsOpen} onClose={()=>setSettingsOpen(false)} theme={theme} setTheme={setTheme} />
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
